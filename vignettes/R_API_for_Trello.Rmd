---
title: "R API for Trello"
author: "Jakub Chromec"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R API for Trello}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
library(httr)
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
```

This document explains how to interact with Trello from R, using the Trello API. Specifically, you will learn how to:

- retrieve data
- add, update and remove data
- authenticate your access (for private and team boards)

If you are at least vaguely familiar with the Trello API, skip the intro.

Introduction
------------

Most things in Trello live on a __Board__. A board encapsulates a hierarchy of _resources:_  __Members, Teams, Lists, Cards, Custom fields__ and __Actions__. Some of the resources contain additional data (e.g. cards have labels, due dates etc.) or other nested resources (e.g. boards have lists, cards, label definitions etc.) 

Each resource can have a parent resource (e.g. a board is a parent resource for a card) and child resources (a card can include actions as a child resource). A resource can have more than one parent (a board and a list are both parents to a card).

To access a resource, you need to know its unique ID, or the ID of its parent resource. In some cases (e.g. with boards or cards), you can use the resource URL instead. This is sometimes useful because URLs can be found in the address bar of your browser (unlike IDs).

In the Trello API [documentation](https://developers.trello.com/docs/api-introduction), the terms "model" and "resource" are used interchangeably. So I use them as synonyms here, although I try to stick to "resource".

Getting data
------------

The following snippet fetches 5 cards from the [trelloR demo board](https://trello.com/b/Pw3EioMM/trellor-r-api-for-trello). This is a public board and so does not require authentication:

```{r, results='hide'}
library(trelloR)
board_url = "https://trello.com/b/Pw3EioMM/trellor-r-api-for-trello"
param = list(fields = "id,name,idList,labels")
cards = get_board_cards(board_url, query = param, limit = 5)
```

The result is a data.frame:

``` {r}
cards
```

As you can see, nested resources can be obtained by querying their parent resource. In the above example, we didn't have to query each card individually to get their names, labels etc. Instead, we just queried the board to get all of its cards.

A general way of retrieving data from a board is to use the function `get_model()` which allows you to specify parameters of the query. However, `trelloR` also includes a number of wrappers for specific resources. For example: 

- use `get_board_cards()` to get cards from a particular board
- use `get_card_members()` to get a list of people assigned to a card
- use `get_board_fields()` to get custom field definitions
- use `get_card_fields()` to get custom field values

These wrappers eliminate most of the effort and make the code easier to read. For an overview of available wrappers, call `?get_board`, `?get_card`, `?get_team`, `?get_member`, `?get_list` or `?get_id`.

If there is no wrapper for the query you need to make, you can call `get_model()` directly or use it to make your own wrapper. The following example creates a wrapper that fetches all updates to a given card. Notice we use a filter because updates are a type of action, and we don't need to retrieve *all* actions for this example:

```{r}
get_card_updates = function(id, ...) {
    get_model(parent = "card", child  = "actions", id = id, filter = "updateCard", ...)
}
```

Such a function can be called the usual way, supplying a card URL or ID:

```{r, results='hide'}
card_id = cards$id[4]
card_updates = get_card_updates(card_id)
```

```{r}
card_updates
```

See `?get_model` to see what additional arguments you can use. If you want to find out about the kind of parameters you are going to need for your query, consult the [Trello API reference](https://developers.trello.com/v1.0/reference).

Error handling
--------------

If a request fails because of a client-side or server-side error, the error code is reprinted in the console. Additional server messages are also included to make debugging easier. See the example with invalid card ID below:

```{r, results='hide'}
tryCatch(
    expr  = get_card_actions(id = "ThisIsGoingToFail"),
    error = function(e) message(e$message)
)
```

After a server-side error, the request will be re-send two more times, with random delay before each attempt. If it fails for the 3rd time, the error message is printed in the console and nothing is returned.

Accessing private/team boards
-----------------------------

Access to private/team boards requires authorization. This is done by creating a secure token to communicate with the Trello API. 

To create a token, **login** to Trello and visit the [Developer Start Page](https://trello.com/app-key/). Get your developer credentials there, i.e. your "key" and "secret". Then, call the `get_token()` function to create a token for your project. This will also trigger first-time authorization in the browser (you only have to do it once for a given project):

```r
my_token = get_token(key = your_key, secret = your_secret)
```

You will also be offered an option to store the authentication data in your working directory, in a hidden `'.httr-oauth'` file. Make sure you keep it in a **safe, non-shared** location. You will then be re-using this token when intearcting with Trello.

You can create multiple tokens with different permissions, scope etc. When visiting your Settings page in Trello, you will see your tokens among the list of apps with access to your Trello account. To make it easier to recognize the tokens you have created, use the `appname` argument when creating a token.

See `?get_token` for additional arguments.

Getting and searching private/team data
---------------------------------------

Having obtained your token, you can call `get_my_boards()` to get an overview of your boards. It returns a `data.frame` with board names and IDs related to the user who authorized the app. This may be a good starting point since IDs are necessary to fetch any data from Trello:

```
my_boards = get_my_boards(my_token)
```

For other functions, just feed the token to the `token` argument:

```
cards = get_board_cards(board_url, token = my_token)
```

__Searching__ also requires a token. For example:

```{r eval=FALSE}
search_members("Tony Stark", token = my_token)
```

In order to __add, update and delete__ resources, you need to create a token with writing permissions, e.g.:

```r
my_token = get_token(key = your_key, secret = your_secret, scope=c("read", "write"))
```

Adding resources
----------------

The `post_model()` function allows you to create new resources. To create a new resource, you have to specify a `model` (eg. "card") and a `token` with permissions to write. The content of the new resource (such as *name*, *decription* or *labels*) has to be passed as a named list to the `body` argument.

The following example creates a new card and places it at the bottom of a list (consult the [Trello API reference](https://developers.trello.com/v1.0/reference) for query parameters):

```
payload = list(
  name = "My new card!", desc = "An example card.", 
  pos = "bottom",
  idList = list_id # get it by calling get_board_lists()
)
post_model(model = "card", body = payload, token = my_token)
```
When successful, the request returns a named list of values describing the newly created resource, including its ID. This is very useful as you can immediately capture the ID if you need it.

See `?post_model` for additional arguments.

There are also some wrappers for this function: see `?add_board`, `?add_card`, `?add_checklist`, `?add_checkitem`, `?add_comment`, `?add_label`, `?add_list` and `?add_field`.

Updating resources
------------------

The `put_model()` function follows the same logic as the `post_model()` function, but can only be called on existing resources See `?update_card`, `?update_card_labels`, `?update_card_members`, `?update_checkitem` and `?update_field`.

Deleting resources
------------------

To delete resources, use `delete_model()` and its wrappers: `?delete_card`, `?delete_checklist`, `?delete_checkitem`, `?delete_field` and `?delete_field_option`.

__Caution:__ Deleted resources cannot be brought back!

Disclaimer
----------

`trelloR` is not affiliated, associated, authorized, endorsed by or in any way officially connected to Trello, Inc. (www.trello.com).

Built with
----------

```{r}
sessionInfo()
```
